# TASK003: オーナー（管理者）専用管理画面

## 1. ユーザーニーズ

### 1.1 背景
サービス運営者がユーザーやお問い合わせを効率的に管理できる管理画面が必要です。現在、管理者がデータを確認・管理するための専用インターフェースが存在しないため、データベースに直接アクセスする必要があり、運用効率が低い状況です。

### 1.2 解決したい課題
- ユーザー情報の一覧表示と管理ができない
- お問い合わせの確認と管理ができない
- サービス全体の統計情報を簡単に確認できない
- 一般ユーザーが管理画面にアクセスできてしまうセキュリティリスク

### 1.3 期待される効果
- 管理者がWebブラウザから簡単にユーザーとお問い合わせを管理できる
- サービス全体の統計情報を一目で把握できる
- セキュリティが強化され、管理者のみがアクセス可能になる
- 運用効率が向上し、サービス品質の向上につながる

---

## 2. 仕様要件

### 2.1 機能要件

#### 2.1.1 認証・認可
- **管理者のみアクセス可能**
  - `role: "admin"`を持つユーザーのみアクセス可能
  - 一般ユーザー（`role: "user"`）がアクセスした場合は403エラー画面を表示
  - 未認証ユーザーがアクセスした場合はログイン画面にリダイレクト

#### 2.1.2 ダッシュボード（`/admin`）
- **統計情報の表示**
  - 総ユーザー数
  - 総お問い合わせ数
  - MUIのCardコンポーネントを使用して視覚的に表示

#### 2.1.3 ユーザー管理（`/admin/users`）
- **ユーザー一覧表示**
  - MUIのDataGridを使用して一覧表示
  - 表示項目：名前、メールアドレス、ロール、作成日時
  - ページネーション機能
  - ソート機能
  - 検索機能（名前、メールアドレスで検索可能）
- **権限変更**
  - ユーザーのロール（`user` ↔ `admin`）を変更可能
  - 確認ダイアログを表示してから変更
- **ユーザー削除**
  - ユーザーを削除可能
  - 確認ダイアログを表示してから削除

#### 2.1.4 お問い合わせ管理（`/admin/contacts`）
- **お問い合わせ一覧表示**
  - MUIのDataGridを使用して一覧表示
  - 表示項目：名前、メールアドレス、件名、作成日時
  - ページネーション機能
  - ソート機能
  - 検索機能（名前、メールアドレス、件名で検索可能）
- **詳細表示**
  - お問い合わせの詳細情報をモーダルまたは別ページで表示
  - 表示項目：名前、メールアドレス、件名、本文、作成日時
- **お問い合わせ削除**
  - お問い合わせを削除可能
  - 確認ダイアログを表示してから削除

### 2.2 非機能要件

#### 2.2.1 セキュリティ
- 管理者権限チェックをミドルウェアで実装
- API Routeでも管理者権限をチェック
- 一般ユーザーがアクセスした場合は403エラーを返す

#### 2.2.2 UI/UX
- Material-UI（MUI）を使用した統一されたデザイン
- レスポンシブデザイン対応
- ローディング状態の表示
- エラーメッセージの適切な表示

#### 2.2.3 パフォーマンス
- データのページネーションで大量データに対応
- 必要最小限のデータのみ取得

---

## 3. 処理手順設計

### 3.1 システム構成

```
/admin
├── page.tsx (ダッシュボード)
├── users/
│   └── page.tsx (ユーザー管理)
└── contacts/
    ├── page.tsx (お問い合わせ一覧)
    └── [id]/
        └── page.tsx (お問い合わせ詳細)

/api/admin
├── stats/
│   └── route.ts (統計情報取得)
├── users/
│   └── route.ts (ユーザー一覧取得、権限変更、削除)
└── contacts/
    └── route.ts (お問い合わせ一覧取得、削除)
```

### 3.2 ミドルウェア設計

#### 3.2.1 管理者権限チェックミドルウェア
```typescript
// src/middleware.ts に追加
1. /admin/* パスへのアクセスを検出
2. セッションを確認
   - セッションがない場合 → /auth/signin にリダイレクト
3. セッションからユーザー情報を取得
4. ユーザーのroleを確認
   - role !== 'admin' → 403エラーページにリダイレクト
   - role === 'admin' → リクエストを許可
```

### 3.3 API Route設計

#### 3.3.1 `/api/admin/stats` (GET)
```typescript
処理手順:
1. セッションを確認
2. 管理者権限をチェック（role === 'admin'）
3. MongoDBから統計情報を取得
   - usersコレクションの総件数
   - contactsコレクションの総件数
4. JSON形式で返却
```

#### 3.3.2 `/api/admin/users` (GET, PATCH, DELETE)
```typescript
GET処理手順:
1. セッションを確認
2. 管理者権限をチェック
3. クエリパラメータからページ番号、ソート、検索条件を取得
4. MongoDBからユーザー一覧を取得（ページネーション対応）
5. JSON形式で返却

PATCH処理手順:
1. セッションを確認
2. 管理者権限をチェック
3. リクエストボディからユーザーIDと新しいロールを取得
4. MongoDBでユーザーのロールを更新
5. 更新結果を返却

DELETE処理手順:
1. セッションを確認
2. 管理者権限をチェック
3. リクエストボディからユーザーIDを取得
4. MongoDBでユーザーを削除
5. 削除結果を返却
```

#### 3.3.3 `/api/admin/contacts` (GET, DELETE)
```typescript
GET処理手順:
1. セッションを確認
2. 管理者権限をチェック
3. クエリパラメータからページ番号、ソート、検索条件を取得
4. MongoDBからお問い合わせ一覧を取得（ページネーション対応）
5. JSON形式で返却

DELETE処理手順:
1. セッションを確認
2. 管理者権限をチェック
3. リクエストボディからお問い合わせIDを取得
4. MongoDBでお問い合わせを削除
5. 削除結果を返却
```

### 3.4 ページコンポーネント設計

#### 3.4.1 `/admin/page.tsx` (ダッシュボード)
```typescript
処理手順:
1. ページマウント時に統計情報APIを呼び出し
2. ローディング状態を表示
3. 統計情報を取得したらMUI Cardで表示
4. エラーが発生したらエラーメッセージを表示
```

#### 3.4.2 `/admin/users/page.tsx` (ユーザー管理)
```typescript
処理手順:
1. ページマウント時にユーザー一覧APIを呼び出し
2. MUI DataGridにデータを設定
3. 権限変更ボタンクリック時:
   - 確認ダイアログを表示
   - 確認後、PATCH APIを呼び出し
   - 成功後、一覧を再取得
4. 削除ボタンクリック時:
   - 確認ダイアログを表示
   - 確認後、DELETE APIを呼び出し
   - 成功後、一覧を再取得
```

#### 3.4.3 `/admin/contacts/page.tsx` (お問い合わせ管理)
```typescript
処理手順:
1. ページマウント時にお問い合わせ一覧APIを呼び出し
2. MUI DataGridにデータを設定
3. 詳細表示ボタンクリック時:
   - モーダルまたは別ページで詳細を表示
4. 削除ボタンクリック時:
   - 確認ダイアログを表示
   - 確認後、DELETE APIを呼び出し
   - 成功後、一覧を再取得
```

### 3.5 403エラーページ設計

#### 3.5.1 `/admin/403/page.tsx`
```typescript
処理手順:
1. 403エラーメッセージを表示
2. 「ホームに戻る」ボタンを表示
3. 管理者でないことを明確に伝えるメッセージを表示
```

---

## 4. データベース設計

### 4.1 既存モデルの利用

#### 4.1.1 Userモデル
- `name`: ユーザー名
- `email`: メールアドレス
- `role`: ロール（'user' または 'admin'）
- `createdAt`: 作成日時
- `updatedAt`: 更新日時

#### 4.1.2 Contactモデル
- `name`: 名前
- `email`: メールアドレス
- `subject`: 件名
- `message`: 本文
- `createdAt`: 作成日時

---

## 5. UIコンポーネント設計

### 5.1 使用するMUIコンポーネント
- **Card**: 統計情報の表示
- **DataGrid**: 一覧表示
- **Button**: アクションボタン
- **Dialog**: 確認ダイアログ
- **Typography**: テキスト表示
- **Box**: レイアウト
- **Container**: コンテナ
- **AppBar**: ヘッダー（既存のHeaderコンポーネントを使用）

### 5.2 レイアウト
- ヘッダーにナビゲーションメニューを追加（管理者のみ表示）
- サイドバーまたはタブで管理画面の各セクションにアクセス可能

---

## 6. エラーハンドリング

### 6.1 API Routeでのエラーハンドリング
- 管理者権限がない場合: 403エラーを返す
- セッションがない場合: 401エラーを返す
- データベースエラー: 500エラーを返す
- バリデーションエラー: 400エラーを返す

### 6.2 フロントエンドでのエラーハンドリング
- APIエラーをキャッチしてユーザーフレンドリーなメッセージを表示
- ローディング状態を適切に管理

---

## 7. セキュリティ考慮事項

### 7.1 認証・認可
- ミドルウェアとAPI Routeの両方で管理者権限をチェック
- セッション情報を信頼できるソースから取得

### 7.2 データ保護
- 管理者のみがユーザー情報とお問い合わせ情報にアクセス可能
- 削除操作は確認ダイアログで二重確認

---

## 8. 実装順序

1. ミドルウェアの拡張（管理者権限チェック）
2. 403エラーページの作成
3. API Routeの実装（stats, users, contacts）
4. ダッシュボードページの実装
5. ユーザー管理ページの実装
6. お問い合わせ管理ページの実装
7. ヘッダーに管理画面へのリンクを追加（管理者のみ表示）
8. テストと動作確認

---

## 9. テスト項目

### 9.1 認証・認可テスト
- [ ] 管理者が`/admin`にアクセスできる
- [ ] 一般ユーザーが`/admin`にアクセスすると403エラーが表示される
- [ ] 未認証ユーザーが`/admin`にアクセスするとログイン画面にリダイレクトされる

### 9.2 機能テスト
- [ ] ダッシュボードで統計情報が正しく表示される
- [ ] ユーザー一覧が正しく表示される
- [ ] ユーザーの権限変更が正しく動作する
- [ ] ユーザーの削除が正しく動作する
- [ ] お問い合わせ一覧が正しく表示される
- [ ] お問い合わせの詳細が正しく表示される
- [ ] お問い合わせの削除が正しく動作する

### 9.3 UI/UXテスト
- [ ] レスポンシブデザインが正しく動作する
- [ ] ローディング状態が適切に表示される
- [ ] エラーメッセージが適切に表示される

---

## 10. 完了条件

- [ ] 管理者のみが管理画面にアクセスできる
- [ ] ダッシュボードで統計情報が表示される
- [ ] ユーザー管理機能が動作する
- [ ] お問い合わせ管理機能が動作する
- [ ] 403エラーページが正しく表示される
- [ ] すべてのテスト項目がパスする
