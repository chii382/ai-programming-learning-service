# TASK002: Google認証機能

## 1. ユーザーニーズ

### 1.1 背景
ユーザーがサービスを利用する際に、簡単にログインできる認証機能が必要です。現在はログイン・サインアップページがプレースホルダーのみで、実際に認証を行う機能がありません。Googleアカウントを使用した認証により、ユーザーは新規登録の手間を省き、既存のGoogleアカウントで簡単にログインできるようになります。

### 1.2 ユーザーの要望
- **簡単にログインできる**: 複雑な登録手順なしで、Googleアカウントでワンクリックログイン
- **セキュアな認証**: 安全な認証方法でアカウントを保護したい
- **ログイン状態の確認**: 自分がログインしているかどうかを常に確認できる
- **簡単にログアウトできる**: いつでも簡単にログアウトできる
- **個人情報の管理**: 自分の情報を確認・管理できる
- **認証が必要な機能へのアクセス**: ログインしたユーザーのみが利用できる機能がある

### 1.3 解決すべき課題
- 現在ログイン・サインアップページが機能していない
- ユーザー認証の仕組みがない
- ユーザー情報を管理・保存する仕組みがない
- 認証が必要なページを保護する仕組みがない

---

## 2. 仕様要件

### 2.1 機能要件

#### 2.1.1 Googleログインボタン
- **表示場所**: ログイン画面（`/auth/signin`）
- **UI**: Googleのブランドガイドラインに準拠したボタンデザイン
- **動作**: クリックでGoogle認証フローを開始
- **認証成功後**: ダッシュボードまたは元のページにリダイレクト

#### 2.1.2 ログイン画面
- **画面パス**: `/auth/signin`
- **表示内容**:
  - サービス名・ロゴ
  - Googleログインボタン
  - 説明文（Googleアカウントでログインする旨）
- **UIコンポーネント**: MUIのButton、Typographyを使用
- **レイアウト**: レスポンシブ対応、中央配置

#### 2.1.3 ログアウト機能
- **表示場所**: ヘッダー（ログイン時）
- **動作**: クリックでセッションを破棄し、ログアウト
- **ログアウト後**: ホームページまたはログイン画面にリダイレクト

#### 2.1.4 セッション管理
- **セッション管理**: NextAuth.jsのセッション管理機能を使用
- **セッション情報**: ユーザーID、名前、メールアドレス、画像URL
- **セッション有効期限**: NextAuth.jsのデフォルト設定に従う
- **セッション更新**: 自動更新機能を使用

#### 2.1.5 ユーザー情報のMongoDB保存
- **データベース**: MongoDB
- **コレクション**: users
- **保存項目**:
  - name（文字列、必須）
  - email（文字列、必須、ユニーク）
  - image（文字列、オプション）
  - role（文字列、デフォルト: "user"）
  - createdAt（日時、自動設定）
  - updatedAt（日時、自動更新）
- **モデル**: Mongooseを使用してUserモデルを定義
- **保存タイミング**: 初回ログイン時、またはユーザー情報更新時

#### 2.1.6 ダッシュボード（認証保護ページ）
- **画面パス**: `/dashboard`
- **アクセス制限**: 認証済みユーザーのみアクセス可能
- **未認証時の動作**: ログイン画面にリダイレクト
- **表示内容**:
  - ユーザー情報（名前、メールアドレス、アバター）
  - ウェルカムメッセージ
  - 今後追加する機能へのリンク

#### 2.1.7 ヘッダーのログイン状態表示
- **未ログイン時**: 「ログイン」ボタンを表示
- **ログイン時**:
  - ユーザーアバター（画像またはイニシャル）
  - ユーザー名
  - ログアウトボタン
- **UIコンポーネント**: MUIのAvatar、Menu、MenuItemを使用
- **レスポンシブ対応**: モバイルではメニュー形式で表示

### 2.2 非機能要件

#### 2.2.1 パフォーマンス
- ログイン処理の応答時間: 3秒以内
- セッション確認の応答時間: 即座に表示
- ページ遷移の応答時間: 1秒以内

#### 2.2.2 セキュリティ
- OAuth 2.0認証フローを使用
- セッション情報の暗号化
- CSRF対策（NextAuth.js標準機能）
- 認証トークンの安全な管理
- ユーザー情報の適切な保護

#### 2.2.3 ユーザビリティ
- わかりやすいログイン・ログアウト操作
- ログイン状態の明確な表示
- エラー時の適切なメッセージ表示
- レスポンシブデザイン対応

### 2.3 技術要件

#### 2.3.1 使用技術
- **認証ライブラリ**: NextAuth.js v5
- **認証プロバイダー**: Google OAuth 2.0
- **フロントエンド**: Next.js 15, React 18, Material-UI
- **バックエンド**: Next.js API Routes
- **データベース**: MongoDB, Mongoose
- **セッション管理**: NextAuth.jsのセッション管理機能

#### 2.3.2 ファイル構成
```
src/
├── app/
│   ├── auth/
│   │   └── signin/
│   │       └── page.tsx (ログイン画面)
│   ├── dashboard/
│   │   └── page.tsx (ダッシュボード)
│   ├── api/
│   │   └── auth/
│   │       └── [...nextauth]/
│   │           └── route.ts (NextAuth設定)
│   └── components/
│       └── Header.tsx (ヘッダーコンポーネント更新)
├── models/
│   └── User.ts (Userモデル)
└── middleware.ts (認証ミドルウェア)
```

#### 2.3.3 環境変数
- `GOOGLE_CLIENT_ID`: Google OAuth 2.0 クライアントID
- `GOOGLE_CLIENT_SECRET`: Google OAuth 2.0 クライアントシークレット
- `NEXTAUTH_URL`: アプリケーションのURL（本番環境用）
- `NEXTAUTH_SECRET`: セッション暗号化用のシークレットキー
- `MONGODB_URI`: MongoDB接続URI（既存）

---

## 3. 処理手順設計

### 3.1 ログインフロー

#### 3.1.1 ユーザーがログインボタンをクリック
1. `/auth/signin`ページにアクセス
2. Googleログインボタンをクリック
3. NextAuth.jsがGoogle認証フローを開始

#### 3.1.2 Google認証処理
1. Google認証画面にリダイレクト
2. ユーザーがGoogleアカウントでログイン
3. アプリケーションへのアクセス許可を確認
4. 認証コードを取得

#### 3.1.3 認証成功後の処理
1. NextAuth.jsが認証コードをトークンに交換
2. Google APIからユーザー情報を取得（名前、メールアドレス、画像URL）
3. MongoDBでユーザーを検索（emailで検索）
4. ユーザーが存在しない場合:
   - 新しいUserドキュメントを作成
   - name, email, image, role, createdAtを保存
5. ユーザーが存在する場合:
   - 既存のユーザー情報を更新（必要に応じて）
6. セッションを作成
7. ダッシュボードまたは元のページにリダイレクト

### 3.2 ログアウトフロー

#### 3.2.1 ユーザーがログアウトボタンをクリック
1. ヘッダーのログアウトボタンをクリック
2. NextAuth.jsの`signOut`関数を呼び出し

#### 3.2.2 ログアウト処理
1. セッションを破棄
2. クッキーを削除
3. ホームページまたはログイン画面にリダイレクト

### 3.3 認証チェックフロー

#### 3.3.1 ページアクセス時の認証チェック
1. ユーザーが保護されたページ（`/dashboard`など）にアクセス
2. ミドルウェアがリクエストをインターセプト
3. セッションを確認
4. セッションが存在する場合:
   - リクエストを許可
   - ページを表示
5. セッションが存在しない場合:
   - `/auth/signin`にリダイレクト
   - 元のURLをクエリパラメータに保存（`callbackUrl`）

### 3.4 セッション管理フロー

#### 3.4.1 セッション取得
1. クライアント側で`useSession`フックを使用
2. NextAuth.jsがセッション情報を取得
3. ユーザー情報（名前、メールアドレス、画像URL）を返却

#### 3.4.2 セッション更新
1. NextAuth.jsが自動的にセッションを更新
2. セッション有効期限が近づいた場合、自動的にリフレッシュ

### 3.5 ユーザー情報保存フロー

#### 3.5.1 初回ログイン時
1. Google認証成功後、ユーザー情報を取得
2. MongoDBでemailを検索
3. ユーザーが存在しない場合:
   - Userモデルを使用して新しいドキュメントを作成
   - 必須フィールド（name, email）を設定
   - オプションフィールド（image）を設定
   - roleを"user"に設定
   - createdAtを現在の日時に設定
   - データベースに保存

#### 3.5.2 既存ユーザーのログイン時
1. Google認証成功後、ユーザー情報を取得
2. MongoDBでemailを検索
3. ユーザーが存在する場合:
   - 既存のユーザー情報を取得
   - 必要に応じて情報を更新（name, image）
   - updatedAtを現在の日時に更新

---

## 4. データモデル設計

### 4.1 Userモデル

```typescript
interface IUser extends Document {
  name: string;           // ユーザー名（必須）
  email: string;          // メールアドレス（必須、ユニーク）
  image?: string;         // プロフィール画像URL（オプション）
  role: string;           // ユーザーロール（デフォルト: "user"）
  createdAt: Date;       // 作成日時（自動設定）
  updatedAt: Date;        // 更新日時（自動更新）
}
```

### 4.2 スキーマ定義

- **name**: String型、必須、最大100文字
- **email**: String型、必須、ユニーク、メール形式バリデーション
- **image**: String型、オプション、最大500文字
- **role**: String型、デフォルト値"user"、enum: ["user", "admin"]
- **createdAt**: Date型、デフォルト値Date.now
- **updatedAt**: Date型、自動更新

---

## 5. API設計

### 5.1 NextAuth API Routes

#### 5.1.1 `/api/auth/[...nextauth]/route.ts`
- **役割**: NextAuth.jsの設定とAPIエンドポイント
- **処理内容**:
  - GoogleProviderの設定
  - コールバック処理
  - セッション管理
  - ユーザー情報の取得と保存

### 5.2 認証エンドポイント

- `/api/auth/signin`: ログイン処理
- `/api/auth/signout`: ログアウト処理
- `/api/auth/session`: セッション情報取得
- `/api/auth/callback/google`: Google認証コールバック

---

## 6. ミドルウェア設計

### 6.1 認証ミドルウェア

#### 6.1.1 保護対象パス
- `/dashboard`: ダッシュボード
- `/dashboard/*`: ダッシュボード配下のすべてのパス

#### 6.1.2 処理内容
1. リクエストパスを確認
2. 保護対象パスの場合:
   - セッションを確認
   - セッションが存在しない場合、`/auth/signin`にリダイレクト
   - セッションが存在する場合、リクエストを許可
3. 保護対象外のパスの場合:
   - リクエストを許可

---

## 7. UI/UX設計

### 7.1 ログイン画面

#### 7.1.1 レイアウト
- 中央配置のカード形式
- サービス名・ロゴを上部に配置
- Googleログインボタンを中央に配置
- 説明文を下部に配置

#### 7.1.2 Googleログインボタン
- Googleのブランドガイドラインに準拠
- アイコンとテキストを表示
- ホバー効果を追加

### 7.2 ヘッダー

#### 7.2.1 未ログイン時
- 左側: サービス名・ロゴ
- 右側: 「ログイン」ボタン

#### 7.2.2 ログイン時
- 左側: サービス名・ロゴ
- 右側: 
  - アバター（画像またはイニシャル）
  - ユーザー名
  - ドロップダウンメニュー（ログアウトボタン）

### 7.3 ダッシュボード

#### 7.3.1 レイアウト
- コンテナ形式
- ウェルカムメッセージ
- ユーザー情報カード
- 今後追加する機能へのリンク

---

## 8. エラーハンドリング

### 8.1 認証エラー
- Google認証失敗時: エラーメッセージを表示し、ログイン画面に戻る
- セッションエラー時: ログイン画面にリダイレクト
- データベースエラー時: エラーログを記録し、適切なエラーメッセージを表示

### 8.2 ネットワークエラー
- ネットワークエラー時: リトライ機能を実装
- タイムアウト時: 適切なエラーメッセージを表示

---

## 9. テスト要件

### 9.1 機能テスト
- Googleログインが正常に動作するか
- ログアウトが正常に動作するか
- セッション管理が正常に動作するか
- ユーザー情報がMongoDBに正しく保存されるか
- 認証保護ページが正しく保護されているか

### 9.2 セキュリティテスト
- 未認証ユーザーが保護ページにアクセスできないか
- セッションが適切に管理されているか
- CSRF対策が機能しているか

---

## 10. 実装順序

1. NextAuth.jsのインストールと設定
2. Google OAuth 2.0設定
3. Userモデルの作成
4. NextAuth設定ファイルの作成
5. ログイン画面の作成
6. ヘッダーコンポーネントの更新
7. ダッシュボードページの作成
8. 認証ミドルウェアの実装
9. テストとデバッグ


