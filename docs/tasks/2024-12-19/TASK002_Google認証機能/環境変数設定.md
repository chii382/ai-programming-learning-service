# TASK002: Google認証機能 - 環境変数設定

## 必要な環境変数

`.env.local`ファイルに以下の環境変数を追加してください。

### 認証関連

```env
# NextAuth.js設定
AUTH_SECRET=your_generated_secret_here
# または（後方互換性のため）
NEXTAUTH_SECRET=your_generated_secret_here

# Google OAuth 2.0設定
GOOGLE_CLIENT_ID=your_google_client_id_here
GOOGLE_CLIENT_SECRET=your_google_client_secret_here

# NextAuth.js URL（本番環境用）
NEXTAUTH_URL=http://localhost:3000
```

### データベース関連（既存）

```env
# MongoDB接続URI（既存の設定を使用）
MONGODB_URI=mongodb+srv://akirapapa_db_user:akirapapa@cluster0.yx71oyz.mongodb.net/?appName=Cluster0
```

---

## 環境変数の取得方法

### 1. AUTH_SECRETの生成

NextAuth.jsのセッション暗号化に使用するシークレットキーを生成します。

#### 方法1: NextAuth.jsコマンドを使用（推奨）

```bash
npx auth secret
```

実行すると、ランダムなシークレットキーが生成されます。これを`AUTH_SECRET`に設定してください。

#### 方法2: オンラインツールを使用

以下のいずれかのツールを使用してシークレットキーを生成できます：
- [generate-secret.vercel.app](https://generate-secret.vercel.app/32)
- OpenSSLコマンド: `openssl rand -base64 32`

生成されたキーを`AUTH_SECRET`に設定してください。

---

### 2. Google OAuth 2.0認証情報の取得

#### 2.1 Google Cloud Consoleでプロジェクトを作成

1. [Google Cloud Console](https://console.cloud.google.com/)にアクセス
2. 新しいプロジェクトを作成（または既存のプロジェクトを選択）
3. プロジェクト名を入力して作成

#### 2.2 OAuth同意画面の設定

1. 左側のメニューから「APIとサービス」→「OAuth同意画面」を選択
2. ユーザータイプを選択（外部または内部）
3. アプリ情報を入力：
   - アプリ名: 「AIコードレビュー」など
   - ユーザーサポートメール: あなたのメールアドレス
   - デベロッパーの連絡先情報: あなたのメールアドレス
4. 「保存して次へ」をクリック
5. スコープはデフォルトのまま「保存して次へ」をクリック
6. テストユーザーを追加（開発中の場合）または「保存して次へ」をクリック
7. 概要を確認して「ダッシュボードに戻る」をクリック

#### 2.3 OAuth 2.0クライアントIDの作成

1. 左側のメニューから「APIとサービス」→「認証情報」を選択
2. 「認証情報を作成」→「OAuth 2.0 クライアント ID」を選択
3. アプリケーションの種類を「ウェブアプリケーション」に選択
4. 名前を入力（例: 「AIコードレビュー - Web Client」）
5. 承認済みのリダイレクト URIを追加：
   - 開発環境: `http://localhost:3000/api/auth/callback/google`
   - 本番環境: `https://your-domain.com/api/auth/callback/google`
6. 「作成」をクリック
7. **クライアントID**と**クライアントシークレット**が表示されます
   - これらをコピーして、`.env.local`に設定してください

---

## 環境変数の設定例

`.env.local`ファイルの例：

```env
# MongoDB接続（既存）
MONGODB_URI=mongodb+srv://akirapapa_db_user:akirapapa@cluster0.yx71oyz.mongodb.net/?appName=Cluster0

# SMTP設定（既存）
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=aiaikou@gmail.com
SMTP_PASSWORD=dgxyslhhmbpzjfwl
ADMIN_EMAIL=jullyo0o0@gmail.com

# NextAuth.js設定（新規追加）
AUTH_SECRET=your_generated_secret_key_here_minimum_32_characters
GOOGLE_CLIENT_ID=your_google_client_id_here.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=your_google_client_secret_here

# 開発環境用
NEXTAUTH_URL=http://localhost:3000
```

---

## 本番環境での設定

### Vercelでの設定

1. Vercelのプロジェクト設定ページにアクセス
2. 「Settings」→「Environment Variables」を選択
3. 以下の環境変数を追加：
   - `AUTH_SECRET`: 生成したシークレットキー
   - `GOOGLE_CLIENT_ID`: Google OAuth 2.0 クライアントID
   - `GOOGLE_CLIENT_SECRET`: Google OAuth 2.0 クライアントシークレット
   - `NEXTAUTH_URL`: 本番環境のURL（例: `https://your-domain.com`）
   - `MONGODB_URI`: MongoDB接続URI（既存）

### Google OAuth 2.0の本番環境設定

1. Google Cloud ConsoleでOAuth 2.0クライアントIDの設定を開く
2. 「承認済みのリダイレクト URI」に本番環境のURLを追加：
   - `https://your-domain.com/api/auth/callback/google`
3. 変更を保存

---

## 注意事項

1. **AUTH_SECRETの重要性**
   - セッションの暗号化に使用されるため、強力なランダムな文字列を使用してください
   - 本番環境と開発環境で異なる値を使用することを推奨します
   - 絶対にGitリポジトリにコミットしないでください

2. **Google OAuth 2.0の制限**
   - 開発中は「テストユーザー」のみがログインできます
   - 本番環境で一般公開する場合は、OAuth同意画面を公開する必要があります

3. **NEXTAUTH_URL**
   - 開発環境: `http://localhost:3000`
   - 本番環境: 実際のドメインURL（例: `https://your-domain.com`）

4. **環境変数の確認**
   - すべての環境変数が正しく設定されているか確認してください
   - 設定後、開発サーバーを再起動してください

---

## トラブルシューティング

### エラー: "AUTH_SECRET is not set"
- `.env.local`ファイルに`AUTH_SECRET`が設定されているか確認
- 開発サーバーを再起動

### エラー: "GOOGLE_CLIENT_ID is not set"
- `.env.local`ファイルに`GOOGLE_CLIENT_ID`が設定されているか確認
- Google Cloud ConsoleでクライアントIDが正しく作成されているか確認

### エラー: "Redirect URI mismatch"
- Google Cloud Consoleで承認済みのリダイレクトURIが正しく設定されているか確認
- 開発環境: `http://localhost:3000/api/auth/callback/google`
- 本番環境: `https://your-domain.com/api/auth/callback/google`

### ログインできない
- Google Cloud ConsoleでOAuth同意画面が正しく設定されているか確認
- テストユーザーが追加されているか確認（開発中の場合）
- ブラウザのコンソールでエラーメッセージを確認






