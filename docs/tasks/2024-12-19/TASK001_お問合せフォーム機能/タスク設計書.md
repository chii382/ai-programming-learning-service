# TASK001: お問合せフォーム機能

## 1. ユーザーニーズ

### 1.1 背景
ユーザーがサービスについて質問や要望を伝えるための連絡手段が必要です。現在はお問い合わせページがプレースホルダーのみで、実際に連絡を取る方法がありません。

### 1.2 ユーザーの要望
- **簡単に問い合わせができる**: 複雑な手順なしで、必要な情報を入力するだけで問い合わせができる
- **入力内容の確認ができる**: 送信前に内容を確認できる
- **送信完了の確認ができる**: 送信が成功したことを明確に知らせてほしい
- **管理者が確実に受け取れる**: 問い合わせ内容が確実に管理者に届く
- **問い合わせ履歴が残る**: 後から問い合わせ内容を確認できる

### 1.3 解決すべき課題
- 現在お問い合わせページが機能していない
- ユーザーからの問い合わせを受け取る仕組みがない
- 問い合わせ内容を管理・保存する仕組みがない

---

## 2. 仕様要件

### 2.1 機能要件

#### 2.1.1 お問い合わせフォーム画面
- **画面パス**: `/contact`
- **入力項目**:
  - 名前（必須）
  - メールアドレス（必須、メール形式チェック）
  - 件名（必須）
  - 本文（必須）
- **UIコンポーネント**: MUIのTextField、Buttonを使用
- **レイアウト**: レスポンシブ対応、中央配置

#### 2.1.2 入力バリデーション
- **必須チェック**: すべての項目が必須
- **メール形式チェック**: メールアドレスが正しい形式か確認
- **エラーメッセージ表示**: バリデーションエラー時に適切なメッセージを表示
- **リアルタイムバリデーション**: 入力中または送信時にバリデーション実行

#### 2.1.3 メール送信機能
- **送信先**: 管理者メールアドレス
- **送信方法**: Nodemailerを使用
- **送信内容**: 
  - 送信者名
  - 送信者メールアドレス
  - 件名
  - 本文
- **送信タイミング**: フォーム送信ボタンクリック時

#### 2.1.4 データベース保存
- **データベース**: MongoDB
- **コレクション**: contacts
- **保存項目**:
  - name（文字列）
  - email（文字列）
  - subject（文字列）
  - message（文字列）
  - createdAt（日時）
- **モデル**: Mongooseを使用してContactモデルを定義

#### 2.1.5 送信完了画面
- **表示内容**: 送信完了メッセージ
- **表示タイミング**: メール送信とDB保存が成功した後
- **ナビゲーション**: ホームに戻るボタン

### 2.2 非機能要件

#### 2.2.1 パフォーマンス
- フォーム送信の応答時間: 3秒以内
- バリデーションの応答時間: 即座に表示

#### 2.2.2 セキュリティ
- 入力値のサニタイズ
- CSRF対策（Next.js標準機能）
- メール送信のエラーハンドリング

#### 2.2.3 ユーザビリティ
- わかりやすいエラーメッセージ
- 送信中のローディング表示
- レスポンシブデザイン対応

### 2.3 技術要件

#### 2.3.1 使用技術
- **フロントエンド**: Next.js 15, React 18, Material-UI
- **バックエンド**: Next.js API Routes
- **データベース**: MongoDB, Mongoose
- **メール送信**: Nodemailer
- **バリデーション**: カスタムバリデーション + MUIのFormControl

#### 2.3.2 ファイル構成
```
src/app/
  ├── contact/
  │   ├── page.tsx (お問い合わせフォーム画面)
  │   └── success/
  │       └── page.tsx (送信完了画面)
  └── api/
      └── contact/
          └── route.ts (API Route)
src/models/
  └── Contact.ts (Mongooseモデル)
src/lib/
  └── mongodb.ts (MongoDB接続設定)
  └── mailer.ts (Nodemailer設定)
```

---

## 3. 処理手順設計

### 3.1 お問い合わせフォーム送信フロー

```
[ユーザー]
    ↓
[お問い合わせフォーム画面 (/contact)]
    ↓
[入力項目入力]
    ↓
[送信ボタンクリック]
    ↓
[クライアント側バリデーション]
    ↓
    ├─ [エラーあり] → [エラーメッセージ表示] → [入力画面に戻る]
    ↓
    └─ [エラーなし]
        ↓
[API Route (/api/contact) にPOSTリクエスト]
    ↓
[サーバー側バリデーション]
    ↓
    ├─ [エラーあり] → [エラーレスポンス] → [エラーメッセージ表示]
    ↓
    └─ [エラーなし]
        ↓
[MongoDBに保存]
    ↓
    ├─ [保存失敗] → [エラーレスポンス] → [エラーメッセージ表示]
    ↓
    └─ [保存成功]
        ↓
[Nodemailerでメール送信]
    ↓
    ├─ [送信失敗] → [エラーレスポンス] → [エラーメッセージ表示]
    ↓
    └─ [送信成功]
        ↓
[送信完了画面 (/contact/success) にリダイレクト]
    ↓
[完了メッセージ表示]
```

### 3.2 詳細処理手順

#### 3.2.1 フォーム画面表示
1. `/contact`にアクセス
2. フォームコンポーネントをレンダリング
3. 各入力フィールドを初期化（空文字列）
4. バリデーションエラーをクリア

#### 3.2.2 入力処理
1. ユーザーが各フィールドに入力
2. リアルタイムバリデーション（オプション）
3. 入力値をstateに保存

#### 3.2.3 送信処理（クライアント側）
1. 送信ボタンクリック
2. クライアント側バリデーション実行
   - 名前: 空でないか
   - メールアドレス: 空でないか、メール形式か
   - 件名: 空でないか
   - 本文: 空でないか
3. バリデーションエラーがあればエラーメッセージ表示して処理終了
4. ローディング状態をtrueに設定
5. `/api/contact`にPOSTリクエスト送信
   - リクエストボディ: { name, email, subject, message }

#### 3.2.4 API Route処理（サーバー側）
1. POSTリクエスト受信
2. リクエストボディからデータ取得
3. サーバー側バリデーション実行
   - 各項目の存在確認
   - メール形式チェック
   - 文字数制限チェック（必要に応じて）
4. MongoDB接続
5. Contactモデルを使用してデータ保存
   - name, email, subject, message, createdAtを保存
6. Nodemailer設定を読み込み
7. 管理者にメール送信
   - From: 送信者のメールアドレス
   - To: 管理者メールアドレス
   - Subject: [お問い合わせ] {件名}
   - Body: 送信者情報と本文を含む
8. 成功レスポンス返却（200 OK）
9. エラーが発生した場合はエラーレスポンス返却（400, 500など）

#### 3.2.5 送信完了画面表示
1. API Routeから成功レスポンス受信
2. `/contact/success`にリダイレクト
3. 送信完了メッセージ表示
4. ホームに戻るボタン表示

### 3.3 エラーハンドリング

#### 3.3.1 クライアント側エラー
- **バリデーションエラー**: エラーメッセージを各フィールドの下に表示
- **ネットワークエラー**: トーストまたはアラートでエラー表示
- **APIエラー**: サーバーから返されたエラーメッセージを表示

#### 3.3.2 サーバー側エラー
- **バリデーションエラー**: 400 Bad Requestでエラーメッセージ返却
- **MongoDB接続エラー**: 500 Internal Server Errorでエラーメッセージ返却
- **メール送信エラー**: 500 Internal Server Errorでエラーメッセージ返却（DB保存は成功している場合）

### 3.4 データモデル設計

#### 3.4.1 Contactスキーマ
```typescript
{
  name: String (required, maxLength: 100)
  email: String (required, maxLength: 255, email format)
  subject: String (required, maxLength: 200)
  message: String (required, maxLength: 5000)
  createdAt: Date (default: Date.now)
}
```

---

## 4. 実装チェックリスト

### 4.1 環境設定
- [ ] MongoDB接続設定ファイル作成
- [ ] Nodemailer設定ファイル作成
- [ ] 環境変数設定（.env.local）
  - [ ] MONGODB_URI
  - [ ] SMTP_HOST
  - [ ] SMTP_PORT
  - [ ] SMTP_USER
  - [ ] SMTP_PASS
  - [ ] ADMIN_EMAIL

### 4.2 データベース
- [ ] Contactモデル作成
- [ ] MongoDB接続関数作成

### 4.3 フロントエンド
- [ ] お問い合わせフォーム画面実装
- [ ] バリデーション実装
- [ ] エラーメッセージ表示実装
- [ ] ローディング状態実装
- [ ] 送信完了画面実装

### 4.4 バックエンド
- [ ] API Route実装
- [ ] サーバー側バリデーション実装
- [ ] MongoDB保存処理実装
- [ ] メール送信処理実装
- [ ] エラーハンドリング実装

### 4.5 テスト
- [ ] フォーム表示確認
- [ ] バリデーション動作確認
- [ ] メール送信確認
- [ ] データベース保存確認
- [ ] エラーハンドリング確認

---

## 5. 注意事項

1. **環境変数の管理**: 本番環境では環境変数を適切に設定すること
2. **メール送信の失敗**: メール送信が失敗してもDB保存は成功している場合があるため、適切にエラーハンドリングすること
3. **セキュリティ**: 入力値のサニタイズとCSRF対策を忘れずに実装すること
4. **パフォーマンス**: MongoDB接続のプール管理を適切に行うこと
5. **ログ**: エラー発生時は適切にログを記録すること





