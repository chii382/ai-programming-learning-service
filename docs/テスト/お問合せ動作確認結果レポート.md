# お問合せ動作確認結果レポート

## 確認環境

- **確認日**: 2024年12月19日
- **確認者**: AIアシスタント（コードベース分析）
- **ブラウザ**: 未確認（要手動確認）
- **バージョン**: 未確認（要手動確認）
- **OS**: Windows
- **環境**: 開発環境

---

## 実動作テスト結果（HTTP/サーバーログベース）

※この環境ではGUIブラウザの手動操作は行わず、`npm run dev` 実行後に **Playwright（ヘッドレスブラウザ）/HTTP/サーバーログ** で検証しています。  
サーバーは **起動中**（停止は未実施）です。

### 判定（チェックリスト全項目）

#### 1. お問合せフォーム画面の表示
- `/contact` にアクセスできる: **OK**（GET `/contact` 200）
- ページが正しく表示される（レイアウト崩れがない）: **OK**（Playwrightで主要要素表示＆スクリーンショット取得）
- タイトル「お問い合わせ」が表示される: **OK**（HTML内に「お問い合わせ」あり）
- 「ホームに戻る」ボタンが表示され、クリックで `/` に遷移する: **OK**（Playwrightでクリック遷移を確認）
- 入力フィールド（名前/メールアドレス/件名/本文）が表示される: **OK**（HTML内に「名前/メールアドレス/件名/本文」あり）
- 送信ボタン「送信する」が表示される: **OK**（HTML内に「送信する」あり）
- PC/タブレット/スマホ表示でレイアウトが崩れない: **OK**（Playwrightで各viewportのスクリーンショット取得: `test-results/contact-viewports/*.png`）

#### 2. 必須項目の未入力時エラー表示
- 全項目未入力で送信すると、各フィールドに必須エラーが表示され送信されない: **OK**（Playwrightで確認）
- 名前未入力で送信すると「名前を入力してください」が表示される: **OK**（Playwrightで確認）
- メールアドレス未入力で送信すると「メールアドレスを入力してください」が表示される: **OK**（Playwrightで確認）
- 件名未入力で送信すると「件名を入力してください」が表示される: **OK**（Playwrightで確認）
- 本文未入力で送信すると「本文を入力してください」が表示される: **OK**（Playwrightで確認）
- エラー表示後に入力すると、該当フィールドのエラーが解除される: **OK**（Playwrightで確認）

補足（サーバー側）:
- 空/不正で POST `/api/contact` → 400（= サーバー側ガードは動作）

#### 3. メールアドレス形式エラー表示
- `test` で送信すると「有効なメールアドレスを入力してください」が表示され送信されない: **OK**（POST `/api/contact` → 400 同メッセージ）
- `test@` で送信すると同様にエラーになる: **OK**（POST `/api/contact` → 400 同メッセージ）
- `test@example` で送信すると同様にエラーになる: **OK**（POST `/api/contact` → 400 同メッセージ）
- `@example.com` で送信すると同様にエラーになる: **OK**（POST `/api/contact` → 400 同メッセージ）
- `test @example.com`（スペース含む）で送信すると同様にエラーになる: **OK**（POST `/api/contact` → 400 同メッセージ）
- `test@example.com` で送信できる（エラーにならない）: **OK**（POST `/api/contact` → 200）

#### 4. 送信成功時の完了画面表示
- 有効な値で送信できる: **OK**（POST `/api/contact` → 200）
- 送信中はボタン表示が「送信中...」になり、ボタン/フィールドが無効化される: **OK**（Playwrightで確認 ※APIレスポンスはモックでUI確認）
- 送信成功後 `/contact/success` に遷移する: **OK**（Playwrightで確認 ※APIレスポンスはモックでUI確認）
- 完了画面に「お問い合わせを受け付けました」が表示される: **OK**（GET `/contact/success` 200 & 文言あり）
- 完了画面の「ホームに戻る」ボタンで `/` に遷移できる: **OK**（Playwrightでクリック遷移を確認 ※APIレスポンスはモックでUI確認）

#### 5. 管理者へのメール受信確認
- お問い合わせ送信後、`ADMIN_EMAIL` 宛にメールが届く: **NG**（受信箱の確認が必要。ただしサーバーログは「メール送信成功」）
- 迷惑メールフォルダに入っていない: **NG**（要手動確認）
- 件名が `[お問い合わせ] {件名}` 形式になっている: **NG**（要手動確認）
- 本文に「名前/メールアドレス/件名/本文」が含まれている: **NG**（要手動確認）
- HTML表示が崩れていない（テキスト版も読める）: **NG**（要手動確認）

#### 6. MongoDBへのデータ保存確認
- お問い合わせ送信後、MongoDBの `contacts` コレクションにデータが保存される: **NG**
- 保存データに `name/email/subject/message/createdAt` が入っている: **NG**
- `name/subject/message` は trim されている: **NG**
- `email` は小文字化されて保存されている: **NG**

MongoDB Atlas 利用時の注意:
- Atlas の **Network Access → IP Access List** に、送信元のグローバルIPが許可されている: **NG**
- 許可されていない場合、ローカルからは接続できず保存されない（アプリではエラーになる）: **OK**

**NGの根拠（サーバーログ）**:
- `MongooseServerSelectionError: Could not connect to any servers ... IP that isn't whitelisted`

（補足）開発環境ではMongoDB接続不可時に `tmp/contact-submissions.jsonl` へフォールバック保存する挙動を確認しました。

---

## コードベース分析結果

### ✅ 実装確認済み項目

#### 1. お問合せフォーム画面の表示

**基本表示**
- ✅ `/contact` ルートが実装されている（`src/app/contact/page.tsx`）
- ✅ ページタイトル「お問い合わせ」が実装されている（line 145-147）
- ✅ 背景色が`background.default`で設定されている（line 133）
- ✅ Containerが最大幅`md`で制限されている（line 134）

**ヘッダー・ナビゲーション**
- ✅ 「ホームに戻る」ボタンが実装されている（line 136-143）
- ✅ ArrowBackアイコンが使用されている（line 15, 139）
- ✅ `/`へのリンクが設定されている（line 138）

**タイトル表示**
- ✅ 「お問い合わせ」タイトルが実装されている（line 145-147）
- ✅ 中央揃え（`textAlign="center"`）が設定されている（line 145）
- ✅ h3バリアントで実装されている（line 145）

**フォームコンテナ**
- ✅ 白背景のカード（`bgcolor: 'background.paper'`）が実装されている（line 153）
- ✅ パディング（`p: 4`）が設定されている（line 154）
- ✅ ボーダーラディウス（`borderRadius: 2`）が設定されている（line 155）
- ✅ シャドウ（`boxShadow: 2`）が設定されている（line 156）

**フォームフィールド表示**
- ✅ 名前フィールド：`TextField`、`required`、`fullWidth`が実装されている（line 164-174）
- ✅ メールアドレスフィールド：`type="email"`、`required`、`fullWidth`が実装されている（line 176-187）
- ✅ 件名フィールド：`TextField`、`required`、`fullWidth`が実装されている（line 189-199）
- ✅ 本文フィールド：`multiline`、`rows={8}`、`required`、`fullWidth`が実装されている（line 201-213）
- ✅ 送信ボタン：`variant="contained"`、`size="large"`、Sendアイコンが実装されている（line 215-224）

---

#### 2. 必須項目の未入力時エラー表示

**バリデーション実装**
- ✅ `validateForm`関数が実装されている（line 49-80）
- ✅ 名前フィールドのバリデーション：
  - ✅ 未入力チェック：「名前を入力してください」（line 52-53）
  - ✅ 文字数制限チェック：100文字以内（line 54-55）
- ✅ メールアドレスフィールドのバリデーション：
  - ✅ 未入力チェック：「メールアドレスを入力してください」（line 58-59）
  - ✅ メール形式チェック：「有効なメールアドレスを入力してください」（line 60-61）
  - ✅ 文字数制限チェック：255文字以内（line 62-63）
- ✅ 件名フィールドのバリデーション：
  - ✅ 未入力チェック：「件名を入力してください」（line 66-67）
  - ✅ 文字数制限チェック：200文字以内（line 68-69）
- ✅ 本文フィールドのバリデーション：
  - ✅ 未入力チェック：「本文を入力してください」（line 72-73）
  - ✅ 文字数制限チェック：5000文字以内（line 74-75）

**エラー表示**
- ✅ `errors`ステートが実装されている（line 40）
- ✅ `error`プロパティと`helperText`が各TextFieldに設定されている（例：line 169-170）
- ✅ エラー解除機能が`handleChange`に実装されている（line 87-90）

---

#### 3. メールアドレス形式エラー表示

**メール形式バリデーション**
- ✅ `validateEmail`関数が実装されている（line 44-47）
- ✅ 正規表現：`/^[^\s@]+@[^\s@]+\.[^\s@]+$/`が使用されている（line 45）
- ✅ エラーメッセージ：「有効なメールアドレスを入力してください」（line 61）
- ✅ サーバー側でも同様のバリデーションが実装されている（`src/app/api/contact/route.ts` line 20-26）

---

#### 4. 送信成功時の完了画面表示

**送信処理**
- ✅ `isSubmitting`ステートが実装されている（line 41）
- ✅ 送信ボタンのテキストが「送信中...」に変わる（line 223）
- ✅ CircularProgressアイコンが表示される（line 219）
- ✅ 送信ボタンとフィールドが無効化される（`disabled={isSubmitting}`）

**送信完了画面**
- ✅ `/contact/success`ページが実装されている（`src/app/contact/success/page.tsx`）
- ✅ リダイレクト処理が実装されている（`src/app/contact/page.tsx` line 120）
- ✅ CheckCircleアイコンが実装されている（line 30-36）
- ✅ 成功メッセージが実装されている（line 38-40）
- ✅ 説明文が実装されている（line 42-46）
- ✅ 成功アラートが実装されている（line 48-50）
- ✅ 「ホームに戻る」ボタンが実装されている（line 52-60）

---

#### 5. 管理者へのメール受信確認

**メール送信機能**
- ✅ `sendContactEmail`関数が実装されている（`src/lib/mailer.ts` line 37-95）
- ✅ Nodemailerが設定されている（line 11-21）
- ✅ 環境変数から設定を読み込む実装がある：
  - ✅ `SMTP_HOST`（line 13）
  - ✅ `SMTP_PORT`（line 14）
  - ✅ `SMTP_USER`（line 17）
  - ✅ `SMTP_PASSWORD`（line 18）
  - ✅ `ADMIN_EMAIL`（line 43）
- ✅ メール件名が「[お問い合わせ] {件名}」形式で実装されている（line 45）
- ✅ HTML形式とテキスト形式の両方が実装されている（line 46-86）
- ✅ 送信者情報、件名、本文がメールに含まれている（line 46-86）
- ✅ API Routeでメール送信が呼び出されている（`src/app/api/contact/route.ts` line 71-77）
- ✅ メール送信エラー時のハンドリングが実装されている（line 71-77）

---

#### 6. MongoDBへのデータ保存確認

**データ保存機能**
- ✅ MongoDB接続が実装されている（`src/lib/mongodb.ts`）
- ✅ Contactモデルが実装されている（`src/models/Contact.ts`）
- ✅ API Routeでデータ保存が実装されている（`src/app/api/contact/route.ts` line 58-68）
- ✅ データ保存前にtrim処理が実装されている（line 62-65）
- ✅ メールアドレスの小文字変換が実装されている（line 63）
- ✅ `createdAt`フィールドが自動設定される（`src/models/Contact.ts` line 42-45）

**スキーマバリデーション**
- ✅ 名前：必須、最大100文字、trim（line 13-18）
- ✅ メールアドレス：必須、最大255文字、trim、lowercase、メール形式チェック（line 19-29）
- ✅ 件名：必須、最大200文字、trim（line 30-35）
- ✅ 本文：必須、最大5000文字、trim（line 36-41）
- ✅ createdAt：自動設定（line 42-45）

---

### ⚠️ 要確認項目（ブラウザでの動作確認が必要）

以下の項目はコードベースでは実装が確認できていますが、実際のブラウザでの動作確認が必要です：

1. **レスポンシブ表示**
   - PC/タブレット/スマートフォンでの表示確認
   - レイアウトの崩れがないか確認

2. **エラー表示の視覚的確認**
   - エラーメッセージの色（赤色）が正しく表示されるか
   - フィールドのボーダーが赤色になるか
   - エラーメッセージの位置が適切か

3. **送信処理の動作確認**
   - ローディング状態の表示
   - 送信完了後のリダイレクト
   - エラー時のメッセージ表示

4. **メール送信の実際の動作**
   - 実際にメールが送信されるか
   - メールの内容が正しいか
   - メールがスパムフォルダに入らないか

5. **MongoDBへのデータ保存の実際の動作**
   - データが正しく保存されるか
   - データの内容が正しいか
   - trim処理が正しく機能しているか

6. **アクセシビリティ**
   - キーボード操作が可能か
   - スクリーンリーダーでの読み上げ
   - コントラスト比

7. **ブラウザ互換性**
   - Chrome、Firefox、Safari、Edgeでの動作確認

8. **パフォーマンス**
   - ページ読み込み速度
   - 送信処理速度

---

## 実装状況サマリー

### 実装済み機能

1. ✅ お問合せフォーム画面の表示
2. ✅ 必須項目のバリデーション（クライアント側・サーバー側）
3. ✅ メールアドレス形式バリデーション
4. ✅ 送信成功時の完了画面
5. ✅ メール送信機能
6. ✅ MongoDBへのデータ保存機能
7. ✅ エラーハンドリング
8. ✅ ローディング状態の表示

### 要確認項目

1. ⚠️ レスポンシブ表示（ブラウザでの確認が必要）
2. ⚠️ 実際のメール送信動作（環境変数の設定確認が必要）
3. ⚠️ MongoDB接続（環境変数の設定確認が必要）
4. ⚠️ ブラウザ互換性（各ブラウザでの動作確認が必要）
5. ⚠️ パフォーマンス（実際の動作確認が必要）

---

## 次のステップ

1. **ブラウザで`localhost:3000/contact`にアクセス**
2. **チェックリストに沿って各項目を確認**
3. **実際のフォーム送信テストを実施**
4. **メール受信確認**
5. **MongoDBへのデータ保存確認**

---

## 注意事項

- 環境変数（`.env.local`）が正しく設定されていることを確認してください
- MongoDB接続が正常に動作することを確認してください
- SMTP設定が正しく動作することを確認してください
- 実際のメール送信テストを行う際は、テスト用のメールアドレスを使用してください


